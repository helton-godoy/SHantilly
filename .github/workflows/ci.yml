name: ShowBox CI

on:
  push:
    branches: [main, master, develop]
  pull_request:
    branches: [main, master]

jobs:
  build:
    runs-on: ubuntu-latest
    container:
      image: debian:trixie-slim

    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          apt-get update -qq
          apt-get install -qqy \
            build-essential \
            qt6-base-dev \
            libqt6charts6-dev \
            libqt6svg6-dev \
            qmake6 \
            xvfb

      - name: Build ShowBox
        run: |
          cd src/code/SHantilly
          qmake6 SHantilly.pro
          make -j$(nproc)

      - name: Build Tests
        run: |
          cd tests/auto
          qmake6 units.pro
          make

      - name: Run Unit Tests
        run: |
          cd tests/auto
          xvfb-run ./tst_units

      - name: Upload Binary
        uses: actions/upload-artifact@v4
        with:
          name: SHantilly-linux
          path: src/code/SHantilly/bin/SHantilly

  test-compatibility:
    runs-on: ubuntu-latest
    needs: build
    container:
      image: debian:trixie-slim

    steps:
      - uses: actions/checkout@v4

      - name: Install Qt6 runtime
        run: |
          apt-get update -qq
          apt-get install -qqy qt6-base-dev libqt6charts6 libqt6svg6 xvfb

      - name: Download binary
        uses: actions/download-artifact@v4
        with:
          name: SHantilly-linux
          path: bin

      - name: Make executable
        run: chmod +x bin/SHantilly

      - name: Test basic commands
        run: |
          export SHOWBOX_BIN=./bin/SHantilly
          timeout 3 xvfb-run $SHOWBOX_BIN <<< 'add label "Test" show' || echo "OK - dialog shown"
