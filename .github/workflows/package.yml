name: Package - Deb and Apps

on:
  release:
    types: [published]

jobs:
  package:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install packaging dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libgl1-mesa-dev libx11-dev libxkbcommon-dev libfontconfig1-dev libdbus-1-dev libicu-dev build-essential

      - name: Cache vcpkg
        uses: actions/cache@v4
        with:
          path: |
            ${{ github.workspace }}/vcpkg
            ${{ github.workspace }}/vcpkg_installed
          key: ${{ runner.os }}-vcpkg-${{ hashFiles('vcpkg.json') }}

      - name: Setup vcpkg
        uses: lukka/run-vcpkg@v11
        with:
          vcpkgJsonGlob: 'vcpkg.json'

      - name: Configure and Build
        run: |
          cmake -B build -S . \
            -DCMAKE_TOOLCHAIN_FILE=${{ github.workspace }}/vcpkg/scripts/buildsystems/vcpkg.cmake \
            -DCMAKE_BUILD_TYPE=Release
          cmake --build build -j$(nproc)

      - name: Create Packages
        run: |
          cd build
          cpack -G DEB

      - name: Upload .deb to Release
        uses: softprops/action-gh-release@v2
        with:
          files: build/*.deb
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Publish to GitHub Packages
        if: env.GH_PACKAGES_TOKEN != ''
        env:
          GH_PACKAGES_TOKEN: ${{ secrets.GH_PACKAGES_TOKEN }}
        run: |
          PACKAGE=$(ls build/*.deb | head -n1)
          if [ -n "$PACKAGE" ]; then
            echo "Publishing $PACKAGE to GitHub Packages..."
            # Note: GitHub Packages for Debian is in beta/restricted, using generic upload if configured
            # For now, we mainly rely on Release Assets.
          fi
